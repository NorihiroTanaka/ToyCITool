# TASK-002: 実行コンテキスト（環境変数）の注入

## 1. タスク概要
ジョブ実行時の環境変数を管理し、CIツールとしてのメタデータ（ブランチ名、コミットハッシュ、ビルドIDなど）や、ユーザー定義の環境変数をサブプロセスに注入できるようにする。

## 2. 現状の課題
*   **現状:** ホストマシンの環境変数がそのまま、あるいは限定的にしか渡されていない可能性がある。
*   **問題点:** ビルドスクリプト内で「今どのブランチをビルドしているのか」「コミットハッシュは何か」を知る術がない。また、APIキーやパスなどを環境変数経由で渡す仕組みが標準化されていない。

## 3. 仕様・要件

### コアコンセプトへの適合
*   **Docker非依存 (No Docker Dependency):**
    *   環境変数の分離は、OSのプロセス分離機能（`subprocess.Popen` の `env` 引数）のみを利用して行う。
    *   コンテナ技術を使わずに、ホストOSの環境変数をベースとしつつ、ジョブ固有の変数を安全に注入・上書きする仕組みとする。
*   **容易な設定 (Easy Configuration):**
    *   ユーザー定義の環境変数は `config.yaml` のシンプルな `env:` セクションで記述可能にする。
    *   CIツールとして必須のメタデータ（コミットハッシュ等）は自動的に注入し、ユーザーがスクリプト内で設定する必要をなくす。

### 実装内容
*   **対象ファイル:**
    *   `src/core/job_executor.py`: サブプロセス起動時の `env` 引数の生成ロジック。
    *   `src/core/job_service.py` または `src/core/job_matcher.py`: ジョブ定義から環境変数を抽出する処理。
*   **設定ファイル:** `config.yaml` (グローバルな環境変数定義が必要な場合)

### 期待される挙動
ジョブ実行時、以下の環境変数を自動的にセットする：
*   **CI_JOB_ID**: ジョブの一意なID
*   **CI_COMMIT_HASH**: 対象のコミットハッシュ
*   **CI_BRANCH**: 対象のブランチ名
*   **CI_REPO_URL**: リポジトリのURL
*   **CI_WORKSPACE**: ワークスペースのパス

さらに、`config.yaml` やジョブ定義内で指定された環境変数をマージする。

### 実装ステップ
1.  `os.environ.copy()` でベースの環境変数を取得。
2.  CI固有の変数を辞書に追加。
3.  ユーザー定義の変数を辞書に追加（既存の値を上書きするかどうかはポリシーを決める、通常はCI変数が優先または後勝ち）。
4.  `subprocess.Popen` の `env` 引数にこの辞書を渡す。

## 4. 優先度
**High**
（CIツールとして、ビルドスクリプトがコンテキストを認識できることは必須機能であるため）
