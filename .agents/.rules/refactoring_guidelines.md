# リファクタリングガイドライン

このガイドラインは、コードベースの品質を維持・向上させるために、リファクタリングを行う際に遵守すべき原則と実践事項を定めたものです。

## 1. 基本原則

### 1.1 振る舞いの保存
*   **定義**: リファクタリングとは、外部から見たプログラムの振る舞いを変えずに、内部構造を改善することです。
*   **実践**: 機能の追加やバグ修正とリファクタリングを同時に行わないでください。リファクタリング中は、入力に対する出力が以前と完全に一致し続ける必要があります。

### 1.2 テストによる保証
*   **必須事項**: リファクタリングを開始する前に、対象コードをカバーする自動テストが存在し、パスすることを確認してください。
*   **プロセス**:
    1.  既存テストを実行し、グリーンであることを確認する。
    2.  テストが不十分な場合は、現在の振る舞いを保証するテストを追加する（仕様化テスト）。
    3.  小規模な変更を行う。
    4.  テストを実行し、振る舞いが壊れていないことを確認する。
    5.  これを繰り返す（Red-Green-RefactorサイクルのRefactorフェーズを厳守）。

## 2. コード品質と構造

### 2.1 防御的プログラミング
*   **ガード節の活用**: 関数の冒頭で不正な引数や前提条件をチェックし、条件を満たさない場合は直ちにリターンまたは例外スローを行ってください。
*   **早期リターン**: ネストを深くしないために、条件が満たされた時点で関数から抜ける（Early Return）パターンを使用してください。これにより、主要なロジックがインデントの深い位置に記述されることを防ぎます。

### 2.2 単一責任の原則 (SRP)
*   **1関数1責任**: 1つの関数は1つのことだけを行い、その目的が関数名で明確に説明できるようにしてください。
*   **分割の目安**: 関数内に「そして（and）」で繋がるような処理が含まれている場合や、画面に収まらないほど長い場合は、意味のある単位でヘルパー関数に抽出してください。

### 2.3 変数とスコープ
*   **グローバル変数の禁止**: グローバル変数は副作用の温床となり、テストや並列実行を困難にするため、原則として使用しないでください。必要な状態は引数として渡すか、クラスのインスタンス変数としてカプセル化してください。
*   **変数の局所化**: 変数は使用する直前で宣言し、可能な限り狭いスコープ（関数内、ブロック内）に閉じ込めてください。変数のライフサイクルを短くすることで、コードの読みやすさと保守性が向上します。

## 3. 設計指標（結合度と凝集度）

### 3.1 結合度（Coupling）の低減
モジュール間の依存度を低く保つことを目指します。**可能な限り「データ結合」を目指し、特にコアロジックにおいてはデータ結合であることを必須とします。**

以下の結合はリファクタリングにより解消すべき対象です。

*   **内容結合 (Content Coupling) の排除**:
    *   あるモジュールが別のモジュールの内部データや内部ロジックを直接参照・変更している状態。
    *   *対策*: アクセッサ（Getter/Setter）の使用や、インターフェースを通じた対話に変更し、カプセル化を強化してください。
*   **共通結合 (Common Coupling) の排除**:
    *   複数のモジュールが同じグローバルデータを参照している状態。
    *   *対策*: 必要なデータのみを引数として渡す（データ結合またはスタンプ結合）形に変更してください。

### 3.2 凝集度（Cohesion）の向上
モジュール内の要素がどの程度密接に関連しているかを高く保つことを目指します。**可能な限り「機能的凝集」を目指し、特にコアロジックにおいては機能的凝集であることを必須とします。**

以下の凝集度は改善（リファクタリング）の対象です。

*   **偶発的凝集 (Coincidental Cohesion) の解消**:
    *   関係のない機能がたまたま同じモジュール（ファイルやクラス）にある状態（例: `Utilities` クラスになんでも詰め込む）。
    *   *対策*: 機能ごとの責任に基づいて、適切なクラスやモジュールに分割・移動してください。
*   **論理的凝集 (Logical Cohesion) の解消**:
    *   関連する機能がまとまっているが、実行時にフラグ引数などで処理を切り替えている状態（例: `doEverything(action_type)`）。
    *   *対策*: 処理ごとに別々の関数を作成するか、ポリモーフィズム（Strategyパターンなど）を活用して分岐を排除してください。
